# Плагин для Android Studio

Плагин LIDCO для IntelliJ подключает Android Studio (и любую JetBrains IDE) к HTTP-серверу LIDCO, предоставляя AI-чат, ревью кода, объяснения, рефакторинг и инлайн-дополнение.

## Требования

1. Android Studio Koala (2024.1) или новее / IntelliJ IDEA 2024.1+
2. Запущенный сервер LIDCO (`lidco serve`)
3. JDK 17+ (для сборки из исходников)

## Установка

### Из исходников

```bash
cd ide/android-studio-plugin

# Собрать плагин
./gradlew buildPlugin

# Архив будет здесь:
# build/distributions/lidco-intellij-plugin-0.1.0.zip
```

Установка в Android Studio:
1. **Settings** > **Plugins** > значок шестерёнки > **Install Plugin from Disk...**
2. Выберите `build/distributions/lidco-intellij-plugin-0.1.0.zip`
3. Перезапустите IDE

### Запуск в режиме разработки

```bash
cd ide/android-studio-plugin
./gradlew runIde
```

Это запустит изолированный экземпляр IDE с предустановленным плагином.

## Настройка

Откройте **Settings** > **Tools** > **LIDCO**:

| Параметр | По умолчанию | Описание |
|----------|-------------|----------|
| Server URL | `http://127.0.0.1:8321` | Адрес сервера LIDCO |
| API Token | _(пусто)_ | Bearer-токен (должен совпадать с `LIDCO_API_TOKEN` на сервере) |
| Default Agent | _(пусто)_ | Предвыбранный агент (пусто = автоматическая маршрутизация) |
| Enable SSE streaming | `true` | Потоковая передача ответов по частям |

## Функции

### 1. Окно чата

Открыть: **View** > **Tool Windows** > **LIDCO** (или нажмите на значок LIDCO на правой боковой панели)

- Введите сообщение и нажмите **Enter** для отправки
- Нажмите **Shift+Enter** для новой строки
- Выберите агента из выпадающего списка (или оставьте "auto")
- Ответы отображаются с Markdown-форматированием и подсветкой кода
- При включённом стриминге текст появляется постепенно

### 2. Действия контекстного меню

Выделите код в редакторе, нажмите правую кнопку мыши и найдите подменю **LIDCO**:

| Действие | Что делает |
|----------|-----------|
| **Review Code** | Отправляет выделенный код агенту `reviewer`. Показывает результат в уведомлении. |
| **Explain Code** | Отправляет выделенный код агенту `coder` для объяснения. |
| **Refactor** | Отправляет выделенный код агенту `refactor` для предложений по улучшению. |
| **Send to Chat** | Копирует выделенный код (с путём к файлу и номерами строк) в буфер обмена и открывает окно чата LIDCO. |

Все действия доступны только при выделенном тексте.

### 3. Инлайн-дополнение (Alt+L)

Нажмите **Alt+L** в любом месте редактора для вызова AI-дополнения:

1. Плагин отправляет содержимое файла и позицию курсора на `/api/complete`
2. Сервер генерирует дополнение с помощью настроенной LLM
3. Текст дополнения вставляется в позицию курсора

Также AI-подсказки доступны в обычном меню автодополнения (Ctrl+Space). Подсказки LIDCO отображаются с суффиксом "(LIDCO)" и типом "AI".

### 4. Виджет статусной строки

В правом нижнем углу статусной строки вы увидите:

- **LIDCO: gpt-4o-mini** — подключено, показывается текущая модель
- **LIDCO: offline** — сервер недоступен

Нажмите на виджет для обновления статуса подключения. Виджет обновляется автоматически каждые 30 секунд.

## Пример рабочего процесса

```
1. Запустить сервер:          lidco serve
2. Открыть Android Studio
3. Открыть Kotlin-файл
4. Выделить функцию
5. ПКМ > LIDCO > Review Code
6. Прочитать ревью в уведомлении
7. Открыть чат LIDCO (правая боковая панель)
8. Спросить: "Как оптимизировать эту функцию для корутин?"
9. Применить предложения
10. Нажать Alt+L для AI-дополнения новой строки
```

## Горячие клавиши

| Комбинация | Действие |
|------------|----------|
| **Alt+L** | Инлайн AI-дополнение в позиции курсора |

Для настройки перейдите в **Settings** > **Keymap** и найдите "LIDCO".

## Структура плагина

```
com.lidco.plugin/
├── LidcoPlugin.kt              # Запуск: проверка подключения к серверу
├── settings/
│   └── LidcoSettings.kt        # Постоянные настройки + UI настроек
├── api/
│   ├── LidcoClient.kt          # HTTP-клиент (OkHttp + SSE)
│   └── Models.kt               # Data-классы запросов/ответов
├── chat/
│   ├── ChatToolWindowFactory.kt # Регистрация окна инструментов
│   ├── ChatToolWindow.kt        # UI чата с полем ввода, выбором агента, SSE
│   └── MessagePanel.kt          # Рендеринг Markdown (CommonMark)
├── actions/
│   ├── ReviewAction.kt          # Контекстное меню: Ревью
│   ├── ExplainAction.kt         # Контекстное меню: Объяснение
│   ├── RefactorAction.kt        # Контекстное меню: Рефакторинг
│   ├── SendToChatAction.kt      # Контекстное меню: Отправить в чат
│   └── ActionUtils.kt           # Общие утилиты уведомлений
├── completion/
│   ├── LidcoCompletionProvider.kt  # Contributor автодополнения
│   └── InlineCompleteAction.kt     # Действие Alt+L
└── statusbar/
    └── LidcoStatusWidget.kt     # Статус подключения в статусной строке
```
