# Архитектура

## Обзор системы

```
┌─────────────────────────────────────────────────────────────────────┐
│                      Пользовательские интерфейсы                    │
│                                                                     │
│   ┌───────────┐    ┌──────────────────┐    ┌────────────────────┐  │
│   │  CLI REPL  │    │  HTTP-сервер     │    │  (В будущем:       │  │
│   │  (Rich)    │    │  (FastAPI)       │    │   VSCode, Neovim)  │  │
│   └─────┬─────┘    └────────┬─────────┘    └────────────────────┘  │
│         │                   │                                       │
│         └─────────┬─────────┘                                       │
│                   │                                                  │
│         ┌─────────▼──────────┐                                      │
│         │      Session        │  ← Центральная точка связывания      │
│         │  (конфиг, LLM,     │                                      │
│         │   инструменты,     │                                      │
│         │   агенты, память,  │                                      │
│         │   контекст)        │                                      │
│         └─────────┬──────────┘                                      │
│                   │                                                  │
│    ┌──────────────┼──────────────┐                                  │
│    │              │              │                                   │
│    ▼              ▼              ▼                                   │
│ ┌──────┐  ┌────────────┐  ┌─────────┐                              │
│ │ LLM  │  │Оркестратор │  │ Память  │                              │
│ │Router │  │ (маршру-   │  │         │                              │
│ │      │  │  тизация   │  │         │                              │
│ │      │  │  + история)│  │         │                              │
│ └──┬───┘  └──────┬─────┘  └─────────┘                              │
│    │             │                                                   │
│    ▼             ▼                                                   │
│ ┌──────┐  ┌──────────┐                                              │
│ │LiteLLM│  │  Агенты   │                                             │
│ │      │  │ (цикл    │                                              │
│ │100+  │  │  ReAct)   │                                              │
│ │моделей│  └─────┬────┘                                              │
│ └──────┘        │                                                    │
│                 ▼                                                     │
│          ┌───────────┐                                               │
│          │Инструменты│                                               │
│          │ file_read  │                                               │
│          │ file_write │                                               │
│          │ file_edit  │                                               │
│          │ bash       │                                               │
│          │ git        │                                               │
│          │ glob       │                                               │
│          │ grep       │                                               │
│          └───────────┘                                               │
└─────────────────────────────────────────────────────────────────────┘
```

## Компоненты

### Session (`src/lidco/core/session.py`)

Центральный координатор. Создаётся один раз на запуск CLI или экземпляр сервера.

Ответственность:
- Загрузка конфигурации (YAML + переменные окружения)
- Инициализация LLM-провайдера и роутера моделей
- Создание реестра инструментов со всеми доступными инструментами
- Регистрация встроенных и пользовательских агентов
- Создание оркестратора (LangGraph или простой fallback)
- Управление постоянной памятью
- Построение контекста проекта

### Оркестратор (`src/lidco/agents/orchestrator.py`)

Направляет сообщения пользователя подходящему агенту.

Поток:
1. Если агент указан явно → использовать его напрямую
2. Иначе вызвать LLM с описаниями агентов → LLM выбирает лучшего
3. Переслать сообщение выбранному агенту с историей диалога + контекстом
4. Сохранить обмен в истории для многоходовых диалогов

Две реализации:
- `Orchestrator` — простая маршрутизация с историей диалога
- `GraphOrchestrator` — на основе LangGraph с конечным автоматом (если langgraph доступен)

### Агенты (`src/lidco/agents/`)

Каждый агент — подкласс `BaseAgent`, реализующий цикл ReAct:

```
Системный промпт + Контекст + Сообщение пользователя
         │
         ▼
    ┌─── Вызов LLM ──┐
    │                 │
    │  Вызовы         │
    │  инструментов?  │
    │   ДА ───────────┼──► Выполнить инструменты ──► Добавить результаты ──► Цикл
    │   НЕТ ──────────┼──► Вернуть текстовый ответ
    │                 │
    └─────────────────┘
```

Встроенные агенты определены в `src/lidco/agents/builtin/`. Пользовательские агенты загружаются из YAML-файлов в `~/.lidco/agents/` и `.lidco/agents/`.

### Слой LLM (`src/lidco/llm/`)

- `BaseLLMProvider` — абстрактный интерфейс для вызовов LLM
- `LiteLLMProvider` — реализация через litellm (поддержка 100+ моделей)
- `ModelRouter` — выбор модели, цепочки fallback и повторные попытки

### Инструменты (`src/lidco/tools/`)

Каждый инструмент расширяет `BaseTool`:
- `name` — уникальный идентификатор
- `description` — для function calling LLM
- `parameters` — JSON Schema для аргументов
- `execute(**args)` — асинхронное выполнение, возвращает `ToolResult`

### Память (`src/lidco/core/memory.py`)

Файловое постоянное хранилище:
- JSON-файлы, организованные по категориям
- Глобальные (`~/.lidco/memory/`) и проектные (`.lidco/memory/`)
- Внедряются в промпты агентов как контекст
- Поддерживают CRUD + текстовый поиск

### HTTP-сервер (`src/lidco/server/`)

Приложение FastAPI, оборачивающее Session:

```
Запрос → Middleware (CORS, Auth, Logging) → Эндпоинт → Session/Оркестратор → Ответ
```

- `app.py` — маршруты и обработчики эндпоинтов
- `models.py` — Pydantic-схемы запросов/ответов
- `sse.py` — Server-Sent Events для стриминга
- `middleware.py` — CORS, bearer-токен аутентификация, логирование запросов

## Поток данных: запрос чата

```
1.  IDE отправляет POST /api/chat {"message": "исправь баг", "agent": null}
2.  FastAPI валидирует тело запроса (Pydantic)
3.  Middleware проверяет auth-токен
4.  Эндпоинт получает синглтон Session
5.  Session.get_full_context() строит контекст проекта + память
6.  Orchestrator.handle() направляет к лучшему агенту
7.  Agent.run() входит в цикл ReAct:
    a. Строит системный промпт + контекст
    b. Вызывает LLM
    c. LLM возвращает вызовы инструментов → выполнить → цикл
    d. LLM возвращает текст → выход из цикла
8.  AgentResponse возвращается с содержимым, вызовами инструментов, метаданными
9.  Эндпоинт сериализует в ChatResponse JSON
10. IDE отображает ответ
```

## Поток данных: SSE-стриминг

```
1. IDE отправляет POST /api/chat/stream
2. Сервер возвращает EventSourceResponse
3. stream_chat_response() запускает агента
4. Генерируются события:
   - start: агент выбран
   - tool_call: каждый вызов инструмента
   - token: текст ответа частями по 80 символов
   - done: метаданные
5. IDE обрабатывает события инкрементально
```

## Архитектура плагина (IntelliJ)

```
┌─────────────────────────────────────────┐
│       Android Studio / IntelliJ          │
│                                          │
│  ┌────────────────────────────────────┐  │
│  │      LidcoClient (OkHttp)          │  │
│  │  HTTP-вызовы к localhost:8321      │  │
│  └──────────────┬─────────────────────┘  │
│                 │                         │
│    ┌────────────┼────────────┐           │
│    │            │            │           │
│    ▼            ▼            ▼           │
│ ┌──────┐  ┌─────────┐  ┌──────────┐    │
│ │ Чат  │  │ Действия │  │Дополнение│    │
│ │      │  │ (Ревью,  │  │(Alt+L,   │    │
│ │      │  │Объяснение│  │ popup)   │    │
│ │      │  │Рефакторинг│ │          │    │
│ │      │  │Отправить)│  │          │    │
│ └──────┘  └─────────┘  └──────────┘    │
│                                          │
│ ┌────────────────┐  ┌───────────────┐   │
│ │ Страница       │  │ Виджет статус- │   │
│ │ настроек       │  │ ной строки     │   │
│ │ (URL, токен,   │  │ (подключение,  │   │
│ │  агент, стрим) │  │  имя модели)   │   │
│ └────────────────┘  └───────────────┘   │
└─────────────────────────────────────────┘
```

## Структура директорий

```
lidco/
├── src/lidco/
│   ├── __init__.py          # Пакет, версия
│   ├── __main__.py          # Точка входа CLI + serve
│   ├── agents/              # Система агентов
│   │   ├── base.py          # BaseAgent, AgentConfig, AgentResponse
│   │   ├── registry.py      # AgentRegistry
│   │   ├── orchestrator.py  # Маршрутизация сообщений
│   │   ├── graph.py         # Оркестратор LangGraph
│   │   ├── loader.py        # Обнаружение YAML-агентов
│   │   └── builtin/         # 8 встроенных агентов
│   ├── cli/                 # Интерактивный CLI
│   ├── core/                # Session, конфиг, контекст, память
│   ├── llm/                 # LLM-провайдеры и маршрутизация
│   ├── tools/               # Реализации инструментов
│   ├── plugins/             # Система плагинов/хуков
│   ├── rag/                 # RAG (экспериментальный)
│   └── server/              # HTTP API (FastAPI)
│       ├── app.py           # Маршруты и эндпоинты
│       ├── models.py        # Pydantic-модели
│       ├── sse.py           # SSE-стриминг
│       └── middleware.py    # CORS, auth, логирование
├── ide/android-studio-plugin/  # Плагин IntelliJ (Kotlin)
├── configs/                 # YAML-конфигурации по умолчанию
├── tests/                   # Набор тестов
└── docs/                    # Документация
    ├── en/                  # English
    └── ru/                  # Русский
```
